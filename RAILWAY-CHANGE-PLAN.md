# Railway Studio Private Network Change Plan
**Generated**: 2025-11-21 23:32
**Status**: READY TO EXECUTE (Pending Marcus Todo #1)

## Pre-Execution Checklist

- [x] Railway CLI authenticated
- [x] Backup created: `studio-vars-backup-20251121-233204.json`
- [x] Current configuration documented
- [ ] **BLOCKER**: Wait for Marcus to complete API route analysis (Todo #1)
- [ ] **BLOCKER**: Confirm which variables actually need changing based on Marcus's findings

## Execution Strategy

### Phase 1: Verification (COMPLETE)
✅ Verified Railway project link
✅ Authenticated as Brazley.xyz (nik@bristolavenue.com)
✅ Created backup of all Studio variables
✅ Analyzed current configuration

### Phase 2: Dependency Check (PENDING - Todo #1)
Waiting for Marcus to:
- Analyze API routes in Studio codebase
- Identify which environment variables are actually used
- Determine if any hardcoded public URLs need updating
- Confirm no API routes are directly referencing public Railway URLs

### Phase 3: Execute Changes (READY - AWAITING GO-AHEAD)

**Change Commands** (PREPARED BUT NOT EXECUTED):

#### Option A: If Marcus finds NO issues
```bash
# No changes needed - configuration is already optimal
echo "Studio is already configured for private network"
```

#### Option B: If Marcus finds public URLs in API routes

Based on what Marcus finds, we may need to update local config files only:

```bash
# Update local .env.production to match Railway
cd /Users/quikolas/Documents/GitHub/supabase-master/apps/studio

# Backup local file
cp .env.production .env.production.backup

# Update specific variables to match Railway's private network config
# (Specific changes TBD based on Marcus's findings)
```

### Phase 4: Verification (AFTER CHANGES)

```bash
# Verify Studio variables after any changes
railway variables --service studio | grep -E "(SUPABASE_URL|STUDIO_PG_META_URL|DATABASE_URL)"

# Expected output:
# SUPABASE_URL → http://kong.railway.internal:8000
# STUDIO_PG_META_URL → http://postgres-meta.railway.internal:8080
# DATABASE_URL → postgres://postgres:...@postgres.railway.internal:5432/postgres
```

### Phase 5: Testing (AFTER CHANGES)

```bash
# If changes were made, trigger a redeploy
railway up --service studio

# Monitor deployment
railway logs --service studio

# Health check
curl -I https://studio-production-cfcd.up.railway.app/api/health
```

## Rollback Plan

If issues occur after changes:

```bash
# Method 1: Restore from backup JSON
cd /Users/quikolas/Documents/GitHub/supabase-master

# Read backup and restore each variable
# (Would need script to parse JSON and restore)

# Method 2: Manual rollback of specific variables
railway variables --service studio --set SUPABASE_URL="https://kong-production-80c6.up.railway.app"
railway variables --service studio --set STUDIO_PG_META_URL="https://postgres-meta-production-6c48.up.railway.app"

# Method 3: Redeploy previous version
railway rollback --service studio
```

## Critical Variables Reference

### Variables That MUST Remain Private (Already Correct ✅)
```bash
DATABASE_URL=postgres://postgres:sl2i90d6w7lzgejxxqwh3tiwuqxhtl64@postgres.railway.internal:5432/postgres
MONGODB_URL=mongodb://mongo:pedlSLZyLIwXzNSzaGAwTCKLCfgXtoDW@mongodb.railway.internal:27017
REDIS_URL=redis://default:UTQjVunMdcoeTkszSCjPeAvXjewOTjAm@redis.railway.internal:6379
STUDIO_PG_META_URL=http://postgres-meta.railway.internal:8080
SUPABASE_URL=http://kong.railway.internal:8000
SUPABASE_PUBLIC_URL=kong.railway.internal
```

### Variables That MUST Remain Public (Browser/External Access)
```bash
# These are auto-generated by Railway - DO NOT CHANGE
RAILWAY_PUBLIC_DOMAIN=studio-production-cfcd.up.railway.app
RAILWAY_STATIC_URL=studio-production-cfcd.up.railway.app
RAILWAY_SERVICE_KONG_URL=kong-production-80c6.up.railway.app (external access)
RAILWAY_SERVICE_MINIO_URL=minio-production-f65d.up.railway.app (external access)
```

### Variables That ARE Frontend (NEXT_PUBLIC_*) - Must Use Public URLs
```bash
# From local .env.production (if used):
NEXT_PUBLIC_SITE_URL=https://ogelbase-studio.vercel.app
NEXT_PUBLIC_SUPABASE_URL=https://kong-production-80c6.up.railway.app
NEXT_PUBLIC_API_URL=https://ogelbase-studio.vercel.app/api
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci... (JWT)
```

## Service Port Reference

For building private network URLs:

| Service | Private Network URL | Port | Protocol |
|---------|-------------------|------|----------|
| Postgres | postgres.railway.internal | 5432 | postgresql:// |
| MongoDB | mongodb.railway.internal | 27017 | mongodb:// |
| Redis | redis.railway.internal | 6379 | redis:// |
| Kong | kong.railway.internal | 8000 | http:// |
| Postgres Meta | postgres-meta.railway.internal | 8080 | http:// |
| Minio | minio.railway.internal | 9000 | http:// (assumed) |
| Supabase Auth | supabase-auth.railway.internal | 9999 | http:// (assumed) |
| Studio | studio.railway.internal | 3000 | http:// |

## Potential Gotchas

1. **Railway Auto-Generated Variables**
   - Variables like `RAILWAY_SERVICE_*_URL` are auto-generated
   - They update when Railway changes domains
   - Don't manually override unless necessary

2. **NEXT_PUBLIC vs Server Variables**
   - `NEXT_PUBLIC_*` = Client-side, sent to browser → MUST use public URLs
   - Other variables = Server-side only → SHOULD use private URLs

3. **Kong as Gateway**
   - Kong handles routing between services
   - External clients hit public Kong URL
   - Internal services use private Kong URL
   - Both can coexist

4. **Railway Service Names vs Hostnames**
   - CLI service name might differ from hostname
   - Example: Service "Auth" → Hostname "supabase-auth.railway.internal"
   - Use `railway variables --service <name>` to test

## Success Criteria

After any changes (if needed):

- [ ] Studio loads in browser
- [ ] Database queries work
- [ ] Authentication flows function
- [ ] File uploads work (Minio)
- [ ] No CORS errors in browser console
- [ ] API routes respond correctly
- [ ] No 500 errors in Railway logs
- [ ] Response times similar or better
- [ ] No certificate/SSL errors

## Communication Plan

1. **Before Changes**:
   - Notify team of planned changes
   - Schedule during low-traffic window
   - Have rollback plan ready

2. **During Changes**:
   - Monitor Railway logs in real-time
   - Test each change incrementally
   - Document any issues

3. **After Changes**:
   - Verify all functionality
   - Update documentation
   - Close tickets

## Current Status: HOLDING

**Why**: Waiting for Marcus (Todo #1) to analyze API routes and confirm:
1. Which environment variables are actually used in the codebase
2. If any API routes have hardcoded public URLs
3. Whether local `.env.production` is used for builds

**Next Action**: Once Marcus completes analysis, review findings and determine if ANY changes are actually needed.

**Current Assessment**: Studio is already well-configured for private networking. Changes may be minimal or not needed at all.

---

**Backup Location**: `/Users/quikolas/Documents/GitHub/supabase-master/studio-vars-backup-20251121-233204.json`
**Analysis Document**: `/Users/quikolas/Documents/GitHub/supabase-master/RAILWAY-PRIVATE-NETWORK-ANALYSIS.md`
**Change Plan**: This document
