version: '3.8'

# Local development environment for Kong + Ogelfy
# Run: docker-compose up -d

services:
  # Kong API Gateway
  kong:
    build:
      context: .
      dockerfile: Dockerfile.kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /app/kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_LOG_LEVEL: "debug"
      # Override upstream URLs for local development
      OGELFY_URL: http://ogelfy-1:3000
      OGELFY_1_URL: ogelfy-1
      OGELFY_2_URL: ogelfy-2
      OGELFY_3_URL: ogelfy-3
    ports:
      - "8000:8000"  # Proxy port (external traffic)
      - "8001:8001"  # Admin API (management)
    depends_on:
      - ogelfy-1
      - ogelfy-2
      - ogelfy-3
    networks:
      - ogelfy-network
    restart: unless-stopped

  # Ogelfy instance 1
  ogelfy-1:
    build:
      context: .
      dockerfile: Dockerfile.ogelfy
    environment:
      PORT: 3000
      NODE_ENV: development
      RAILWAY_SERVICE_NAME: ogelfy
      RAILWAY_REPLICA_ID: "1"
    networks:
      - ogelfy-network
    restart: unless-stopped

  # Ogelfy instance 2
  ogelfy-2:
    build:
      context: .
      dockerfile: Dockerfile.ogelfy
    environment:
      PORT: 3000
      NODE_ENV: development
      RAILWAY_SERVICE_NAME: ogelfy
      RAILWAY_REPLICA_ID: "2"
    networks:
      - ogelfy-network
    restart: unless-stopped

  # Ogelfy instance 3
  ogelfy-3:
    build:
      context: .
      dockerfile: Dockerfile.ogelfy
    environment:
      PORT: 3000
      NODE_ENV: development
      RAILWAY_SERVICE_NAME: ogelfy
      RAILWAY_REPLICA_ID: "3"
    networks:
      - ogelfy-network
    restart: unless-stopped

  # Optional: Redis for distributed rate limiting
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - ogelfy-network
    restart: unless-stopped
    ports:
      - "6379:6379"

networks:
  ogelfy-network:
    driver: bridge

volumes:
  redis-data:
