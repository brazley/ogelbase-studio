# Railway Infrastructure Setup for Ogel Deploy

**Date**: 2025-11-22
**Status**: In Progress - MariaDB & Redis Configuration

---

## Current Infrastructure

```
Railway Project: OgelBase
├── Studio (Next.js app)
├── PostgreSQL (platform data)
├── Redis (sessions, cache, queue)
├── MongoDB (minimal usage)
└── [NEW] MariaDB (to be added)
```

---

## Step 1: Add MariaDB Database

### Via Railway Dashboard

1. Go to Railway project: **OgelBase**
2. Click **"+ New"** → **"Database"** → **"Add MySQL"**
3. Configure:
   ```
   Name: mariadb
   Plan: Hobby ($5/month to start)
   Region: us-west1 (same as other services)
   ```

### Internal Connection Details

**DO NOT use public URLs. Always use internal URLs:**

```bash
# ❌ WRONG - Public URL (costs egress fees)
MYSQL_URL=mysql://user:pass@containers-us-west-123.railway.app:1234/railway

# ✅ CORRECT - Internal URL (free, fast)
MYSQL_URL=mysql://user:pass@mariadb.railway.internal:3306/railway
```

**Railway automatically creates:**
```bash
# These variables are available to all services:
MARIADB_HOST=mariadb.railway.internal
MARIADB_PORT=3306
MARIADB_USER=root
MARIADB_PASSWORD=<auto-generated>
MARIADB_DATABASE=railway
```

---

## Step 2: Redis Multi-Database Configuration

### Redis Database Allocation

**Single Redis instance, multiple logical databases (0-15):**

```bash
# Studio (existing usage)
REDIS_URL=redis://default:password@redis.railway.internal:6379/0

# Ogel Ghost Cache
OGEL_REDIS_CACHE_URL=redis://default:password@redis.railway.internal:6379/1

# Ogel Ghost Queue (BullMQ)
OGEL_REDIS_QUEUE_URL=redis://default:password@redis.railway.internal:6379/2

# Future: Build logs
BUILD_LOGS_REDIS_URL=redis://default:password@redis.railway.internal:6379/3

# Future: Rate limiting
RATE_LIMIT_REDIS_URL=redis://default:password@redis.railway.internal:6379/4
```

### Benefits

✅ **Cost**: One Redis instance ($5/month), not 5 instances ($25/month)
✅ **Speed**: All on internal network (no egress)
✅ **Isolation**: Different DB numbers = completely isolated namespaces
✅ **Monitoring**: One Redis to monitor, simpler ops

### Configuration Examples

**Studio (Next.js):**
```typescript
// lib/redis.ts
import Redis from 'ioredis';

export const sessionRedis = new Redis({
  host: 'redis.railway.internal',
  port: 6379,
  password: process.env.REDIS_PASSWORD,
  db: 0, // Studio sessions
});
```

**Ogel Ghost (when deployed):**
```bash
# Environment variables for Appwrite/Ogel Ghost
_APP_REDIS_HOST=redis.railway.internal
_APP_REDIS_PORT=6379
_APP_REDIS_USER=default
_APP_REDIS_PASS=${REDIS_PASSWORD}

# Custom: Use different DBs for cache vs queue
REDIS_CACHE_DB=1
REDIS_QUEUE_DB=2
```

**Unified API (future):**
```typescript
// api/lib/redis.ts
import Redis from 'ioredis';

export const cacheRedis = new Redis({
  host: 'redis.railway.internal',
  port: 6379,
  password: process.env.REDIS_PASSWORD,
  db: 1, // API cache
});

export const queueRedis = new Redis({
  host: 'redis.railway.internal',
  port: 6379,
  password: process.env.REDIS_PASSWORD,
  db: 2, // Background jobs
});
```

---

## Step 3: Internal URL Strategy

### Why Internal URLs Matter

**Public URLs:**
```
studio.ogel.com → Railway Edge → us-west1 data center
                     ↑
                  EGRESS COST ($0.10/GB)
```

**Internal URLs:**
```
studio.railway.internal → mariadb.railway.internal
                              ↑
                         FREE (same private network)
```

### Railway Private Network

All services in the same Railway project can communicate via:
```
<service-name>.railway.internal
```

**Automatic DNS resolution:**
- No configuration needed
- Railway handles service discovery
- Sub-millisecond latency
- Zero egress costs

### Service URLs

```bash
# Existing services (use these in code)
POSTGRES_HOST=postgres.railway.internal:5432
REDIS_HOST=redis.railway.internal:6379
MONGODB_HOST=mongodb.railway.internal:27017

# New service
MARIADB_HOST=mariadb.railway.internal:3306

# Future: Ogel Ghost
OGEL_GHOST_API=http://ogel-ghost.railway.internal:80
```

### Configuration Pattern

**✅ DO THIS:**
```typescript
// Use Railway's service variables
const dbConfig = {
  host: process.env.POSTGRES_HOST || 'postgres.railway.internal',
  port: parseInt(process.env.POSTGRES_PORT || '5432'),
  database: process.env.POSTGRES_DB,
  user: process.env.POSTGRES_USER,
  password: process.env.POSTGRES_PASSWORD,
};
```

**❌ DON'T DO THIS:**
```typescript
// Don't hardcode public URLs
const dbUrl = 'postgresql://containers-us-west-123.railway.app:1234/db';
```

---

## Step 4: Environment Variable Management

### Shared Variables (All Services)

Railway can inject variables into all services:

```bash
# Shared across all services
RAILWAY_ENVIRONMENT=production
REDIS_HOST=redis.railway.internal
REDIS_PORT=6379
REDIS_PASSWORD=<secret>
```

### Service-Specific Variables

Each service can have its own:

```bash
# Studio service only
NEXT_PUBLIC_API_URL=https://api.ogel.com
DATABASE_URL=postgresql://postgres.railway.internal:5432/studio

# Ogel Ghost service only (future)
APPWRITE_DATABASE_URL=mysql://mariadb.railway.internal:3306/appwrite
APPWRITE_REDIS_DB=1
```

---

## Step 5: Database Schema Strategy

### PostgreSQL (Existing)

**Purpose**: Platform data (Studio backend)

```sql
-- Schemas
platform.users
platform.organizations
platform.organization_members
platform.projects
platform.api_keys
platform.billing_subscriptions

-- Future: Ogel Ghost integration
platform.ogel_deployments (
  id,
  project_id,
  appwrite_project_id,    -- Link to Ogel Ghost project
  repo_url,
  branch,
  status,
  deployed_url
)
```

### MariaDB (New)

**Purpose**: Deployed app data (Ogel Ghost backend)

```sql
-- Appwrite's namespace-based isolation
_789_databases
_789_collections
_789_documents
_789_deployments
_789_functions

_890_databases
_890_collections
...
```

**Key difference**: PostgreSQL = your platform, MariaDB = user apps

---

## Step 6: Monitoring Setup

### Redis Monitoring

**Check database usage:**
```bash
# Connect to Redis
railway run redis-cli -h redis.railway.internal

# Check keys in each DB
SELECT 0; DBSIZE;  # Studio sessions
SELECT 1; DBSIZE;  # Ogel Ghost cache
SELECT 2; DBSIZE;  # Ogel Ghost queue
```

**Memory usage:**
```bash
INFO memory
# Used memory by DB:
# db0:keys=1234,expires=500
# db1:keys=5678,expires=1000
# db2:keys=234,expires=0
```

### MariaDB Monitoring

**Connection test:**
```bash
railway run mysql -h mariadb.railway.internal -u root -p
```

**Table sizes:**
```sql
SELECT
  table_schema,
  table_name,
  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb
FROM information_schema.TABLES
WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema')
ORDER BY (data_length + index_length) DESC;
```

---

## Cost Analysis

### Current (Before MariaDB)

```
Studio:       $20/month
PostgreSQL:   $5/month
Redis:        $5/month
MongoDB:      $5/month
──────────────────────
Total:        $35/month
```

### With MariaDB (After)

```
Studio:       $20/month
PostgreSQL:   $5/month
Redis:        $5/month (shared, no increase!)
MongoDB:      $5/month
MariaDB:      $5/month
──────────────────────
Total:        $40/month
```

**Cost increase**: +$5/month only

### With Ogel Ghost (Future)

```
Current:      $40/month
Ogel Ghost:   $10/month (single service)
──────────────────────
Total:        $50/month
```

### With Optimizations (Month 2+)

```
Baseline:              $50/month
Private network:       -$9/month (egress savings)
Service consolidation: -$5/month
──────────────────────
Optimized:             $36/month
```

**Compare to Appwrite Cloud**: $15-25/month per project

---

## Security Best Practices

### 1. Internal-Only Databases

**Never expose database ports publicly:**

```bash
# ✅ CORRECT - Internal only
mariadb.railway.internal:3306

# ❌ WRONG - Public exposure
mariadb-production.railway.app:3306
```

Railway automatically configures databases with no public access.

### 2. Connection Pooling

**Use PgBouncer pattern for PostgreSQL:**
```bash
# Studio connects via pooler
DATABASE_URL=postgresql://postgres.railway.internal:6432/studio
```

**Use ProxySQL pattern for MariaDB (future):**
```bash
# Ogel Ghost connects via proxy
MYSQL_URL=mysql://proxysql.railway.internal:6033/appwrite
```

### 3. Secret Management

**Railway automatically injects secrets:**
```bash
# These are available to all services
$POSTGRES_PASSWORD
$REDIS_PASSWORD
$MARIADB_PASSWORD
```

**Never commit secrets:**
```bash
# .gitignore
.env
.env.local
.env.production
```

---

## Network Topology

```
┌─────────────────────────────────────────────────────────┐
│              Railway Private Network                    │
│           (*.railway.internal DNS)                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────┐    ┌────────────┐    ┌──────────┐      │
│  │  Studio  │───→│ PostgreSQL │    │ MariaDB  │      │
│  │ (Next.js)│    │  :5432     │    │  :3306   │      │
│  └──────────┘    └────────────┘    └──────────┘      │
│       │                                    ↑           │
│       │          ┌──────────┐             │           │
│       └─────────→│  Redis   │←────────────┘           │
│                  │  :6379   │                         │
│                  │ (DB 0-15)│                         │
│                  └──────────┘                         │
│                                                         │
│  [Future: Ogel Ghost]                                 │
│  ┌──────────────┐                                     │
│  │ Ogel Ghost   │───→ MariaDB :3306                   │
│  │ (Appwrite)   │───→ Redis :6379 (DB 1,2)           │
│  └──────────────┘                                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
         ↑                                    ↑
    Public HTTPS                         Public HTTPS
    studio.ogel.com                   ghost.ogel.com
```

---

## Next Steps

### Immediate (Today)

1. ✅ Add MariaDB via Railway dashboard
2. ✅ Document Redis multi-DB strategy
3. ⏳ Test internal URL connectivity
4. ⏳ Update Studio to use internal URLs (if not already)

### This Week

1. Design unified API proxy pattern
2. Create MariaDB schema for Ogel Ghost integration
3. Document deployment workflow
4. Plan Ogel Ghost deployment

### Future (When Ready to Deploy Ogel Ghost)

1. Deploy Ogel Ghost services
2. Configure Ogel Ghost to use MariaDB & Redis
3. Test site deployment workflow
4. Add "Deploy" button to Studio (optional)

---

## Testing Checklist

### After Adding MariaDB

```bash
# 1. Verify service is running
railway status

# 2. Check internal DNS resolution
railway run ping mariadb.railway.internal

# 3. Test connection
railway run mysql -h mariadb.railway.internal -u root -p

# 4. Create test database
mysql> CREATE DATABASE test_ogel;
mysql> SHOW DATABASES;

# 5. Verify from Studio service
# Add to Studio's .env:
MARIADB_HOST=mariadb.railway.internal
MARIADB_PORT=3306

# Test connection from Studio code
```

### Redis Multi-DB Test

```typescript
// Test in Studio
import Redis from 'ioredis';

const redis0 = new Redis({ host: 'redis.railway.internal', db: 0 });
const redis1 = new Redis({ host: 'redis.railway.internal', db: 1 });

await redis0.set('studio:test', 'value1');
await redis1.set('ogel:test', 'value2');

console.log(await redis0.get('studio:test')); // 'value1'
console.log(await redis0.get('ogel:test'));   // null (different DB)
console.log(await redis1.get('ogel:test'));   // 'value2'
```

---

## Rollback Plan

If MariaDB causes issues:

1. **Remove MariaDB service** (Railway dashboard)
2. **Revert any code changes** that reference MariaDB
3. **Cost impact**: -$5/month
4. **No data loss** (nothing deployed to it yet)

---

**Status**: Ready to add MariaDB
**Blocker**: None
**Risk**: Low (new infrastructure, doesn't affect existing services)
**Next**: Execute Railway dashboard steps to add MariaDB

---

**Document maintained by**: Dylan Torres (TPM)
**Last updated**: 2025-11-22
